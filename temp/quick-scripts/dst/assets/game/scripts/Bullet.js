
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/game/scripts/Bullet.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '61c0c6w9SxHAaqoxrMyiAta', 'Bullet');
// game/scripts/Bullet.js

"use strict";

cc.Class({
  "extends": cc.Component,
  properties: {
    sprite: cc.Sprite,
    spriteBundle: "",
    spritePath: "",
    spine: sp.Skeleton,
    spinePre: "",
    aoeHitEffect: !1,
    life: {
      "default": -1,
      tooltip: "毫秒，-1为出屏消失"
    },
    dieOutScreen: !0,
    speed: 500,
    buffSlow: !1,
    buffIce: !1,
    buffPoison: !1,
    dieKeepFrame: 0,
    hitCount: {
      "default": 1,
      tooltip: "攻击次数，默认1次攻击后消失，填2就穿透1次"
    },
    hitChangeAngle: !1,
    jsEffExclusive: !1,
    canReturn: !1
  },
  initBy: function initBy(t, e) {
    this.scene = t;
    this.lv = e;
    this.dieTimer = -1;
    this.hitCounter = this.hitCount;
    this.lifeTimer = -1;

    if (this.canReturn && this.scene) {
      this.returnTimer = this.scene.setTimeout(this.doReturnLogic.bind(this), this.life);
      this.life += this.life;
    }

    if (this.life > 0 && this.scene) {
      this.lifeTimer = this.scene.setTimeout(this.onLifeEnd.bind(this), this.life);
    }
  },
  moveByAngle: function moveByAngle(t) {
    if (this.speed > 0) {
      var e = this.speed / 60;
      var i = t * Math.PI / 180;
      this.moveDelta = cc.v2(e * Math.cos(i), e * Math.sin(i));
    }

    this.node.angle = t;
  },
  doReturnLogic: function doReturnLogic() {
    this.moveDelta = cc.v2(-this.moveDelta.x, -this.moveDelta.y);
  },
  onLifeEnd: function onLifeEnd() {
    this.node.parent = null;
  },
  onMoveEnded: function onMoveEnded() {
    if (-1 != this.lifeTimer && this.scene) {
      this.scene.clearTimeout(this.lifeTimer);
      this.lifeTimer = -1;
    }

    this.node.parent = null;
  },
  update: function update() {
    if (this.scene && !this.scene.timePaused && this.moveDelta) {
      var t = this.moveDelta.mul(cc.director.getScheduler().getTimeScale());
      this.node.position = this.node.position.add(t);
    }
  },
  onHitEnemy: function onHitEnemy(t) {
    var e = this;
    this.hitCounter--;

    if (this.hitCounter <= 0) {
      t.enabled = !1;
      -1 != this.lifeTimer && this.scene && (this.scene.clearTimeout(this.lifeTimer), this.lifeTimer = -1);

      if (this.dieKeepFrame > 0) {
        -1 == this.dieTimer && this.scene && (this.dieTimer = this.scene.setTimeout(function () {
          e.node.parent = null;
        }, 1e3 * this.dieKeepFrame / 60));
      } else {
        this.node.parent = null;
      }
    } else if (this.hitChangeAngle && this.scene) {
      var i = this.scene.chooseEnemyByBullet(this);

      if (i) {
        var n = this.node.position;
        var o = i.node.position.add(cc.v2(0, i.centerY)).sub(n);
        var s = Math.atan2(o.y, o.x);
        this.moveByAngle(180 * s / Math.PI);
      }
    }
  },
  doCollisionLogic: function doCollisionLogic(t, e) {
    if (1 != t.tag) {
      var i = t.getComponent("Enemy");

      if (i && i.hp > 0 && i != this.excludeEnemy) {
        this.a.doBulletAttLogic(this, i);
        this.onHitEnemy(e);
      }
    } else {
      if (this.dieOutScreen) {
        this.onMoveEnded();
      }
    }
  },
  onCollisionEnter: function onCollisionEnter(t, e) {
    if (e.enabled) {
      this.doCollisionLogic(t, e);
    }
  },
  onRangePoisonEnter: function onRangePoisonEnter(t) {
    var e = t.getComponent("Enemy");

    if (e && e.hp > 0) {
      e.addBuffPoison(this.a, 5e3, this.att);
    }
  },
  onAoeCollisionEnter: function onAoeCollisionEnter(t) {
    var e = t.getComponent("Enemy");

    if (e && e.hp > 0) {
      this.a.doBulletAttLogic(this, e);
    }
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0cy9nYW1lL3NjcmlwdHMvQnVsbGV0LmpzIl0sIm5hbWVzIjpbImNjIiwiQ2xhc3MiLCJDb21wb25lbnQiLCJwcm9wZXJ0aWVzIiwic3ByaXRlIiwiU3ByaXRlIiwic3ByaXRlQnVuZGxlIiwic3ByaXRlUGF0aCIsInNwaW5lIiwic3AiLCJTa2VsZXRvbiIsInNwaW5lUHJlIiwiYW9lSGl0RWZmZWN0IiwibGlmZSIsInRvb2x0aXAiLCJkaWVPdXRTY3JlZW4iLCJzcGVlZCIsImJ1ZmZTbG93IiwiYnVmZkljZSIsImJ1ZmZQb2lzb24iLCJkaWVLZWVwRnJhbWUiLCJoaXRDb3VudCIsImhpdENoYW5nZUFuZ2xlIiwianNFZmZFeGNsdXNpdmUiLCJjYW5SZXR1cm4iLCJpbml0QnkiLCJ0IiwiZSIsInNjZW5lIiwibHYiLCJkaWVUaW1lciIsImhpdENvdW50ZXIiLCJsaWZlVGltZXIiLCJyZXR1cm5UaW1lciIsInNldFRpbWVvdXQiLCJkb1JldHVybkxvZ2ljIiwiYmluZCIsIm9uTGlmZUVuZCIsIm1vdmVCeUFuZ2xlIiwiaSIsIk1hdGgiLCJQSSIsIm1vdmVEZWx0YSIsInYyIiwiY29zIiwic2luIiwibm9kZSIsImFuZ2xlIiwieCIsInkiLCJwYXJlbnQiLCJvbk1vdmVFbmRlZCIsImNsZWFyVGltZW91dCIsInVwZGF0ZSIsInRpbWVQYXVzZWQiLCJtdWwiLCJkaXJlY3RvciIsImdldFNjaGVkdWxlciIsImdldFRpbWVTY2FsZSIsInBvc2l0aW9uIiwiYWRkIiwib25IaXRFbmVteSIsImVuYWJsZWQiLCJjaG9vc2VFbmVteUJ5QnVsbGV0IiwibiIsIm8iLCJjZW50ZXJZIiwic3ViIiwicyIsImF0YW4yIiwiZG9Db2xsaXNpb25Mb2dpYyIsInRhZyIsImdldENvbXBvbmVudCIsImhwIiwiZXhjbHVkZUVuZW15IiwiYSIsImRvQnVsbGV0QXR0TG9naWMiLCJvbkNvbGxpc2lvbkVudGVyIiwib25SYW5nZVBvaXNvbkVudGVyIiwiYWRkQnVmZlBvaXNvbiIs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Iiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJjYy5DbGFzcyh7XG4gICAgZXh0ZW5kczogY2MuQ29tcG9uZW50LFxuICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgc3ByaXRlOiBjYy5TcHJpdGUsXG4gICAgICAgIHNwcml0ZUJ1bmRsZTogXCJcIixcbiAgICAgICAgc3ByaXRlUGF0aDogXCJcIixcbiAgICAgICAgc3BpbmU6IHNwLlNrZWxldG9uLFxuICAgICAgICBzcGluZVByZTogXCJcIixcbiAgICAgICAgYW9lSGl0RWZmZWN0OiAhMSxcbiAgICAgICAgbGlmZToge1xuICAgICAgICAgICAgZGVmYXVsdDogLTEsXG4gICAgICAgICAgICB0b29sdGlwOiBcIuavq+enku+8jC0x5Li65Ye65bGP5raI5aSxXCJcbiAgICAgICAgfSxcbiAgICAgICAgZGllT3V0U2NyZWVuOiAhMCxcbiAgICAgICAgc3BlZWQ6IDUwMCxcbiAgICAgICAgYnVmZlNsb3c6ICExLFxuICAgICAgICBidWZmSWNlOiAhMSxcbiAgICAgICAgYnVmZlBvaXNvbjogITEsXG4gICAgICAgIGRpZUtlZXBGcmFtZTogMCxcbiAgICAgICAgaGl0Q291bnQ6IHtcbiAgICAgICAgICAgIGRlZmF1bHQ6IDEsXG4gICAgICAgICAgICB0b29sdGlwOiBcIuaUu+WHu+asoeaVsO+8jOm7mOiupDHmrKHmlLvlh7vlkI7mtojlpLHvvIzloasy5bCx56m/6YCPMeasoVwiXG4gICAgICAgIH0sXG4gICAgICAgIGhpdENoYW5nZUFuZ2xlOiAhMSxcbiAgICAgICAganNFZmZFeGNsdXNpdmU6ICExLFxuICAgICAgICBjYW5SZXR1cm46ICExXG4gICAgfSxcbiAgICBpbml0Qnk6IGZ1bmN0aW9uICh0LCBlKSB7XG4gICAgICAgIHRoaXMuc2NlbmUgPSB0O1xuICAgICAgICB0aGlzLmx2ID0gZTtcbiAgICAgICAgdGhpcy5kaWVUaW1lciA9IC0xO1xuICAgICAgICB0aGlzLmhpdENvdW50ZXIgPSB0aGlzLmhpdENvdW50O1xuICAgICAgICB0aGlzLmxpZmVUaW1lciA9IC0xO1xuICAgICAgICBpZiAodGhpcy5jYW5SZXR1cm4gJiYgdGhpcy5zY2VuZSkge1xuICAgICAgICAgICAgdGhpcy5yZXR1cm5UaW1lciA9IHRoaXMuc2NlbmUuc2V0VGltZW91dCh0aGlzLmRvUmV0dXJuTG9naWMuYmluZCh0aGlzKSwgdGhpcy5saWZlKTtcbiAgICAgICAgICAgIHRoaXMubGlmZSArPSB0aGlzLmxpZmU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGlmZSA+IDAgJiYgdGhpcy5zY2VuZSkge1xuICAgICAgICAgICAgdGhpcy5saWZlVGltZXIgPSB0aGlzLnNjZW5lLnNldFRpbWVvdXQodGhpcy5vbkxpZmVFbmQuYmluZCh0aGlzKSwgdGhpcy5saWZlKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgbW92ZUJ5QW5nbGU6IGZ1bmN0aW9uICh0KSB7XG4gICAgICAgIGlmICh0aGlzLnNwZWVkID4gMCkge1xuICAgICAgICAgICAgdmFyIGUgPSB0aGlzLnNwZWVkIC8gNjA7XG4gICAgICAgICAgICB2YXIgaSA9ICh0ICogTWF0aC5QSSkgLyAxODA7XG4gICAgICAgICAgICB0aGlzLm1vdmVEZWx0YSA9IGNjLnYyKGUgKiBNYXRoLmNvcyhpKSwgZSAqIE1hdGguc2luKGkpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5vZGUuYW5nbGUgPSB0O1xuICAgIH0sXG4gICAgZG9SZXR1cm5Mb2dpYzogZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLm1vdmVEZWx0YSA9IGNjLnYyKC10aGlzLm1vdmVEZWx0YS54LCAtdGhpcy5tb3ZlRGVsdGEueSk7XG4gICAgfSxcbiAgICBvbkxpZmVFbmQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5ub2RlLnBhcmVudCA9IG51bGw7XG4gICAgfSxcbiAgICBvbk1vdmVFbmRlZDogZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoLTEgIT0gdGhpcy5saWZlVGltZXIgJiYgdGhpcy5zY2VuZSkge1xuICAgICAgICAgICAgdGhpcy5zY2VuZS5jbGVhclRpbWVvdXQodGhpcy5saWZlVGltZXIpO1xuICAgICAgICAgICAgdGhpcy5saWZlVGltZXIgPSAtMTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5vZGUucGFyZW50ID0gbnVsbDtcbiAgICB9LFxuICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5zY2VuZSAmJiAhdGhpcy5zY2VuZS50aW1lUGF1c2VkICYmIHRoaXMubW92ZURlbHRhKSB7XG4gICAgICAgICAgICB2YXIgdCA9IHRoaXMubW92ZURlbHRhLm11bChjYy5kaXJlY3Rvci5nZXRTY2hlZHVsZXIoKS5nZXRUaW1lU2NhbGUoKSk7XG4gICAgICAgICAgICB0aGlzLm5vZGUucG9zaXRpb24gPSB0aGlzLm5vZGUucG9zaXRpb24uYWRkKHQpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBvbkhpdEVuZW15OiBmdW5jdGlvbiAodCkge1xuICAgICAgICB2YXIgZSA9IHRoaXM7XG4gICAgICAgIHRoaXMuaGl0Q291bnRlci0tO1xuICAgICAgICBpZiAodGhpcy5oaXRDb3VudGVyIDw9IDApIHtcbiAgICAgICAgICAgIHQuZW5hYmxlZCA9ICExO1xuICAgICAgICAgICAgLTEgIT0gdGhpcy5saWZlVGltZXIgJiYgdGhpcy5zY2VuZSAmJiAodGhpcy5zY2VuZS5jbGVhclRpbWVvdXQodGhpcy5saWZlVGltZXIpLCAodGhpcy5saWZlVGltZXIgPSAtMSkpO1xuICAgICAgICAgICAgaWYgKHRoaXMuZGllS2VlcEZyYW1lID4gMCkge1xuICAgICAgICAgICAgICAgIC0xID09IHRoaXMuZGllVGltZXIgJiYgdGhpcy5zY2VuZSAmJlxuICAgICAgICAgICAgICAgICAgICAodGhpcy5kaWVUaW1lciA9IHRoaXMuc2NlbmUuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLm5vZGUucGFyZW50ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfSwgKDFlMyAqIHRoaXMuZGllS2VlcEZyYW1lKSAvIDYwKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubm9kZS5wYXJlbnQgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaGl0Q2hhbmdlQW5nbGUgJiYgdGhpcy5zY2VuZSkge1xuICAgICAgICAgICAgdmFyIGkgPSB0aGlzLnNjZW5lLmNob29zZUVuZW15QnlCdWxsZXQodGhpcyk7XG4gICAgICAgICAgICBpZiAoaSkge1xuICAgICAgICAgICAgICAgIHZhciBuID0gdGhpcy5ub2RlLnBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIHZhciBvID0gaS5ub2RlLnBvc2l0aW9uLmFkZChjYy52MigwLCBpLmNlbnRlclkpKS5zdWIobik7XG4gICAgICAgICAgICAgICAgdmFyIHMgPSBNYXRoLmF0YW4yKG8ueSwgby54KTtcbiAgICAgICAgICAgICAgICB0aGlzLm1vdmVCeUFuZ2xlKCgxODAgKiBzKSAvIE1hdGguUEkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbiAgICBkb0NvbGxpc2lvbkxvZ2ljOiBmdW5jdGlvbiAodCwgZSkge1xuICAgICAgICBpZiAoMSAhPSB0LnRhZykge1xuICAgICAgICAgICAgdmFyIGkgPSB0LmdldENvbXBvbmVudChcIkVuZW15XCIpO1xuICAgICAgICAgICAgaWYgKGkgJiYgaS5ocCA+IDAgJiYgaSAhPSB0aGlzLmV4Y2x1ZGVFbmVteSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYS5kb0J1bGxldEF0dExvZ2ljKHRoaXMsIGkpO1xuICAgICAgICAgICAgICAgIHRoaXMub25IaXRFbmVteShlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmRpZU91dFNjcmVlbikge1xuICAgICAgICAgICAgICAgIHRoaXMub25Nb3ZlRW5kZWQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgb25Db2xsaXNpb25FbnRlcjogZnVuY3Rpb24gKHQsIGUpIHtcbiAgICAgICAgaWYgKGUuZW5hYmxlZCkge1xuICAgICAgICAgICAgdGhpcy5kb0NvbGxpc2lvbkxvZ2ljKHQsIGUpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBvblJhbmdlUG9pc29uRW50ZXI6IGZ1bmN0aW9uICh0KSB7XG4gICAgICAgIHZhciBlID0gdC5nZXRDb21wb25lbnQoXCJFbmVteVwiKTtcbiAgICAgICAgaWYgKGUgJiYgZS5ocCA+IDApIHtcbiAgICAgICAgICAgIGUuYWRkQnVmZlBvaXNvbih0aGlzLmEsIDVlMywgdGhpcy5hdHQpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBvbkFvZUNvbGxpc2lvbkVudGVyOiBmdW5jdGlvbiAodCkge1xuICAgICAgICB2YXIgZSA9IHQuZ2V0Q29tcG9uZW50KFwiRW5lbXlcIik7XG4gICAgICAgIGlmIChlICYmIGUuaHAgPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmEuZG9CdWxsZXRBdHRMb2dpYyh0aGlzLCBlKTtcbiAgICAgICAgfVxuICAgIH1cbn0pOyJdfQ==